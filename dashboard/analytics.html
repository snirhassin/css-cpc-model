<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | RoyalDeals Seller Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ====== Date range toggles ====== */
        .date-range-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-pill {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.25s;
        }

        .date-pill:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .date-pill.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* ====== KPI grid override for 5 cards ====== */
        .kpi-grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .kpi-grid-5 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .kpi-grid-5 { grid-template-columns: 1fr; }
        }

        /* ====== Main chart card ====== */
        .chart-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-card-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }

        .chart-legend {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
        }

        .chart-legend-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* ====== Attribution Funnel ====== */
        .funnel-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
        }

        .funnel-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 24px;
        }

        .funnel-bars {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .funnel-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .funnel-label {
            width: 110px;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            text-align: right;
        }

        .funnel-bar-track {
            flex: 1;
            height: 40px;
            background: var(--bg);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .funnel-bar-fill {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding-left: 14px;
            transition: width 0.8s ease;
        }

        .funnel-bar-fill span {
            font-size: 13px;
            font-weight: 700;
            color: var(--white);
            white-space: nowrap;
        }

        .funnel-pct {
            width: 60px;
            flex-shrink: 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
        }

        /* ====== Product Performance Table ====== */
        .table-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .table-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .table-card-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }

        .data-table thead th.sort-asc::after {
            content: ' \25B2';
            font-size: 10px;
        }

        .data-table thead th.sort-desc::after {
            content: ' \25BC';
            font-size: 10px;
        }

        .roas-good { color: var(--success); font-weight: 700; }
        .roas-ok { color: var(--warning); font-weight: 700; }
        .roas-bad { color: var(--danger); font-weight: 700; }
    </style>
</head>
<body>

<!-- ====== NAV ====== -->
<nav class="dash-nav">
    <div class="container">
        <a href="dashboard.html" class="dash-nav-logo">
            <div class="dash-nav-logo-icon">R</div>
            <div class="dash-nav-logo-text">Royal<span>Deals</span></div>
        </a>

        <ul class="dash-nav-tabs" id="navTabs">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="bidding.html">Bidding</a></li>
            <li><a href="analytics.html" class="active">Analytics</a></li>
            <li><a href="budget.html">Budget</a></li>
            <li><a href="revshare.html">RevShare Path</a></li>
        </ul>

        <div class="dash-nav-right">
            <div class="dash-nav-balance">
                <span class="dash-nav-balance-label">Bal</span> $287.43
            </div>
            <div class="dash-nav-avatar" title="TechGear Direct">T</div>
        </div>

        <button class="dash-nav-hamburger" id="hamburgerBtn" aria-label="Toggle menu">
            <span></span><span></span><span></span>
        </button>
    </div>
</nav>

<!-- ====== PAGE CONTENT ====== -->
<main class="page-content section-gap">

    <!-- Page header + date range -->
    <div class="page-header">
        <div class="page-header-text">
            <h1>Analytics</h1>
            <p>Track performance, conversions, and attribution across your product catalogue.</p>
        </div>
        <div class="date-range-bar">
            <button class="date-pill" data-days="7">7D</button>
            <button class="date-pill" data-days="14">14D</button>
            <button class="date-pill active" data-days="30">30D</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid-5" id="kpiGrid">
        <div class="kpi-card kpi-card--highlight">
            <div class="kpi-card-label">Total Spend</div>
            <div class="kpi-card-value" id="kpiSpend">$212.57</div>
            <div class="kpi-card-trend kpi-card-trend--up" style="color:#6ee7b7;background:rgba(255,255,255,0.1);">+12.4% vs prior</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-label">Total Clicks</div>
            <div class="kpi-card-value" id="kpiClicks">1,668</div>
            <div class="kpi-card-trend kpi-card-trend--up">+8.7%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-label">Conversions</div>
            <div class="kpi-card-value" id="kpiConversions">110</div>
            <div class="kpi-card-trend kpi-card-trend--up">+15.2%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-label">Avg CPC</div>
            <div class="kpi-card-value" id="kpiCpc">$0.13</div>
            <div class="kpi-card-trend kpi-card-trend--neutral">-1.1%</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-label">ROAS</div>
            <div class="kpi-card-value" id="kpiRoas">8.2x</div>
            <div class="kpi-card-trend kpi-card-trend--up">+6.5%</div>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="chart-card">
        <div class="chart-card-header">
            <h3>Performance Trends</h3>
            <div class="chart-legend">
                <div class="chart-legend-item">
                    <div class="chart-legend-swatch" style="background:#2a5298;"></div> Clicks
                </div>
                <div class="chart-legend-item">
                    <div class="chart-legend-swatch" style="background:#10b981;"></div> Conversions
                </div>
                <div class="chart-legend-item">
                    <div class="chart-legend-swatch" style="background:rgba(232,168,56,0.5);"></div> Spend
                </div>
            </div>
        </div>
        <div class="chart-container chart-container--lg">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- Attribution Funnel -->
    <div class="funnel-card">
        <h3>Attribution Funnel</h3>
        <div class="funnel-bars">
            <div class="funnel-row">
                <div class="funnel-label">Impressions</div>
                <div class="funnel-bar-track">
                    <div class="funnel-bar-fill" style="width:100%; background: var(--primary);">
                        <span>52,730</span>
                    </div>
                </div>
                <div class="funnel-pct">100%</div>
            </div>
            <div class="funnel-row">
                <div class="funnel-label">Clicks</div>
                <div class="funnel-bar-track">
                    <div class="funnel-bar-fill" style="width:42%; background: var(--primary-light);">
                        <span>1,668</span>
                    </div>
                </div>
                <div class="funnel-pct">3.2%</div>
            </div>
            <div class="funnel-row">
                <div class="funnel-label">Add to Cart</div>
                <div class="funnel-bar-track">
                    <div class="funnel-bar-fill" style="width:24%; background: var(--accent);">
                        <span>312</span>
                    </div>
                </div>
                <div class="funnel-pct">18.7%</div>
            </div>
            <div class="funnel-row">
                <div class="funnel-label">Purchases</div>
                <div class="funnel-bar-track">
                    <div class="funnel-bar-fill" style="width:14%; background: var(--success);">
                        <span>110</span>
                    </div>
                </div>
                <div class="funnel-pct">6.6%</div>
            </div>
        </div>
    </div>

    <!-- Product Performance Table -->
    <div class="table-card">
        <div class="table-card-header">
            <h3>Product Performance</h3>
            <button class="btn-secondary btn-sm" id="exportCsvBtn">Export CSV</button>
        </div>
        <div class="data-table-wrapper">
            <table class="data-table" id="productTable">
                <thead>
                    <tr>
                        <th class="sortable" data-key="title">Product</th>
                        <th class="sortable" data-key="clicks" data-type="number">Clicks</th>
                        <th class="sortable" data-key="impressions" data-type="number">Impressions</th>
                        <th class="sortable" data-key="ctr" data-type="number">CTR</th>
                        <th class="sortable" data-key="conversions" data-type="number">Conversions</th>
                        <th class="sortable" data-key="spend" data-type="number">Spend</th>
                        <th class="sortable" data-key="revenue" data-type="number">Revenue</th>
                        <th class="sortable" data-key="roas" data-type="number">ROAS</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
    </div>

</main>

<!-- ====== FOOTER ====== -->
<footer class="dash-footer">
    <div class="container">
        <div class="dash-footer-left">
            <div class="dash-footer-logo-icon">R</div>
            <div class="dash-footer-text">Royal<span>Deals</span> Seller Dashboard</div>
        </div>
        <div class="dash-footer-copyright">&copy; 2026 RoyalDeals. All rights reserved.</div>
        <div class="dash-footer-links">
            <a href="#">Help Centre</a>
            <a href="#">Terms of Service</a>
            <a href="#">Privacy Policy</a>
        </div>
    </div>
</footer>

<!-- ====== SCRIPTS ====== -->
<script src="mock-data.js"></script>
<script src="auction-engine.js"></script>
<script>
(function () {
    'use strict';

    // ---- Hamburger toggle ----
    const hamburger = document.getElementById('hamburgerBtn');
    const navTabs = document.getElementById('navTabs');
    if (hamburger) {
        hamburger.addEventListener('click', () => {
            navTabs.classList.toggle('open');
        });
    }

    // ---- State ----
    let currentDays = 30;
    let dailyHistory = generateDailyHistory(DEMO_PRODUCTS, 47);
    let mainChart = null;
    let sortKey = null;
    let sortDir = 'desc';

    // ---- Date range pills ----
    document.querySelectorAll('.date-pill').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.date-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentDays = parseInt(btn.dataset.days, 10);
            updateAll();
        });
    });

    function sliceDays(data, days) {
        return data.slice(-days);
    }

    // ---- KPI update ----
    function updateKpis(data) {
        const spend = data.reduce((s, d) => s + d.spend, 0);
        const clicks = data.reduce((s, d) => s + d.clicks, 0);
        const conversions = data.reduce((s, d) => s + d.conversions, 0);
        const cpc = clicks > 0 ? spend / clicks : 0;
        const revenue = data.reduce((s, d) => s + d.revenue, 0);
        const roas = spend > 0 ? revenue / spend : 0;

        document.getElementById('kpiSpend').textContent = '$' + spend.toFixed(2);
        document.getElementById('kpiClicks').textContent = clicks.toLocaleString();
        document.getElementById('kpiConversions').textContent = conversions.toLocaleString();
        document.getElementById('kpiCpc').textContent = '$' + cpc.toFixed(2);
        document.getElementById('kpiRoas').textContent = roas.toFixed(1) + 'x';
    }

    // ---- Chart ----
    function renderChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const labels = data.map(d => {
            const dt = new Date(d.date);
            return dt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        });

        if (mainChart) mainChart.destroy();

        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'Clicks',
                        data: data.map(d => d.clicks),
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.35,
                        fill: false,
                        yAxisID: 'y',
                        order: 1
                    },
                    {
                        type: 'line',
                        label: 'Conversions',
                        data: data.map(d => d.conversions),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.35,
                        fill: false,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        type: 'bar',
                        label: 'Spend ($)',
                        data: data.map(d => d.spend),
                        backgroundColor: 'rgba(232, 168, 56, 0.35)',
                        borderColor: 'rgba(232, 168, 56, 0.6)',
                        borderWidth: 1,
                        borderRadius: 4,
                        yAxisID: 'y1',
                        order: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#0f1923',
                        titleFont: { family: 'Inter', size: 13 },
                        bodyFont: { family: 'Inter', size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label === 'Spend ($)') {
                                    return label + ': $' + context.parsed.y.toFixed(2);
                                }
                                return label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: '#64748b',
                            maxRotation: 45
                        }
                    },
                    y: {
                        position: 'left',
                        title: { display: true, text: 'Clicks / Conversions', font: { family: 'Inter', size: 12 }, color: '#64748b' },
                        grid: { color: 'rgba(226, 232, 240, 0.6)' },
                        ticks: { font: { family: 'Inter', size: 11 }, color: '#64748b' }
                    },
                    y1: {
                        position: 'right',
                        title: { display: true, text: 'Spend ($)', font: { family: 'Inter', size: 12 }, color: '#64748b' },
                        grid: { drawOnChartArea: false },
                        ticks: {
                            font: { family: 'Inter', size: 11 },
                            color: '#64748b',
                            callback: v => '$' + v.toFixed(0)
                        }
                    }
                }
            }
        });
    }

    // ---- Product Table ----
    function roasClass(roas) {
        if (roas >= 8) return 'roas-good';
        if (roas >= 4) return 'roas-ok';
        return 'roas-bad';
    }

    function renderProductTable() {
        let products = [...DEMO_PRODUCTS];
        if (sortKey) {
            products.sort((a, b) => {
                let va = a[sortKey], vb = b[sortKey];
                if (typeof va === 'string') va = va.toLowerCase();
                if (typeof vb === 'string') vb = vb.toLowerCase();
                if (va < vb) return sortDir === 'asc' ? -1 : 1;
                if (va > vb) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = products.map(p => `
            <tr>
                <td style="font-weight:600; max-width:260px;" class="truncate" title="${p.title}">${p.title}</td>
                <td>${p.clicks.toLocaleString()}</td>
                <td>${p.impressions.toLocaleString()}</td>
                <td>${p.ctr.toFixed(2)}%</td>
                <td>${p.conversions}</td>
                <td>$${p.spend.toFixed(2)}</td>
                <td>$${p.revenue.toFixed(2)}</td>
                <td class="${roasClass(p.roas)}">${p.roas.toFixed(2)}x</td>
            </tr>
        `).join('');

        // Update header sort indicators
        document.querySelectorAll('#productTable thead th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.key === sortKey) {
                th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
    }

    // ---- Sortable headers ----
    document.querySelectorAll('#productTable thead th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.key;
            if (sortKey === key) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortKey = key;
                sortDir = th.dataset.type === 'number' ? 'desc' : 'asc';
            }
            renderProductTable();
        });
    });

    // ---- Export CSV ----
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
        const headers = ['Product', 'ASIN', 'Clicks', 'Impressions', 'CTR', 'Conversions', 'Spend', 'Revenue', 'ROAS'];
        const rows = DEMO_PRODUCTS.map(p => [
            '"' + p.title.replace(/"/g, '""') + '"',
            p.asin,
            p.clicks,
            p.impressions,
            p.ctr.toFixed(2) + '%',
            p.conversions,
            '$' + p.spend.toFixed(2),
            '$' + p.revenue.toFixed(2),
            p.roas.toFixed(2) + 'x'
        ]);

        let csv = headers.join(',') + '\n';
        csv += rows.map(r => r.join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'product-performance-' + currentDays + 'd.csv';
        a.click();
        URL.revokeObjectURL(url);
    });

    // ---- Master update ----
    function updateAll() {
        const data = sliceDays(dailyHistory, currentDays);
        updateKpis(data);
        renderChart(data);
    }

    // ---- Init ----
    updateAll();
    renderProductTable();

})();
</script>
</body>
</html>
